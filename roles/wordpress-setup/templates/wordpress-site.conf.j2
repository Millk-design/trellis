# {{ ansible_managed }}

server {
  {% if item.value.ssl is defined and item.value.ssl.enabled | default(false) -%}
  listen 443 ssl http2;
  {% else -%}
  listen 80;
  {% endif %}

  server_name  {% for host in site_hosts_canonical %}{{ host }} {% if item.value.multisite.subdomains | default(false) %}*.{{ host }} {% endif %}{% endfor %};
  access_log   {{ www_root }}/{{ item.key }}/logs/access.log;
  error_log    {{ www_root }}/{{ item.key }}/logs/error.log;

  root  {{ www_root }}/{{ item.key }}/{{ item.value.current_path | default('current') }}/web;
  index index.php index.htm index.html;

  charset utf-8;
  {% if env == 'development' -%}
  # See Virtualbox section at http://wiki.nginx.org/Pitfalls
  sendfile off;
  {%- endif %}
  {{ lookup('template', 'multisite-rewrites.conf.j2') | indent(2) }}
  add_header Fastcgi-Cache $upstream_cache_status;

  {% if item.value.ssl is defined and item.value.ssl.enabled | default(false) -%}
  {{ lookup('template', 'https.conf.j2') | indent(2) }}
  {% endif %}

  {% if item.value.ssl is not defined or not item.value.ssl.enabled | default(false) -%}
  include acme-challenge-location.conf;
  {% endif %}

  include includes.d/{{ item.key }}/*.conf;

  {{ lookup('template', 'wordpress-base.conf.j2') | indent(2) }}

  location ~ \.php$ {
    try_files $uri =404;
    error_page 404 /index.php;
    {{ lookup('template', 'cache.conf.j2') | indent(4) }}
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT $realpath_root;
    fastcgi_pass unix:/var/run/php-fpm-wordpress.sock;
  }
}
{{ lookup('template', 'https-redirect.conf.j2') }}
{{ lookup('template', 'redirects.conf.j2') }}
